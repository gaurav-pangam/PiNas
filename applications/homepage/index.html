<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PiNAS System Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #00ff00;
            padding-bottom: 20px;
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .controls label {
            font-size: 1.1em;
        }
        
        .controls select {
            background: #2a2a2a;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 5px 10px;
            font-family: 'Courier New', monospace;
            font-size: 1em;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: #2a2a2a;
            border: 2px solid #00ff00;
            border-radius: 8px;
            padding: 20px;
        }
        
        .card.full-width {
            grid-column: 1 / -1;
        }
        
        .card h2 {
            color: #00ff00;
            margin-bottom: 15px;
            font-size: 1.5em;
            border-bottom: 1px solid #00ff00;
            padding-bottom: 10px;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }
        
        .metric:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            color: #00cc00;
        }
        
        .metric-value {
            color: #00ff00;
            font-weight: bold;
        }
        
        .cpu-cores {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .core {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #00ff00;
            text-align: center;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #1a1a1a;
            border: 1px solid #00ff00;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #00cc00);
            transition: width 0.3s ease;
        }
        
        .task-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .task-item {
            display: grid;
            grid-template-columns: 60px 1fr 80px 80px;
            gap: 10px;
            padding: 8px;
            border-bottom: 1px solid #333;
            font-size: 0.9em;
        }
        
        .task-header {
            font-weight: bold;
            color: #00ff00;
            background: #1a1a1a;
            position: sticky;
            top: 0;
        }
        
        .network-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .last-update {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-top: 20px;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #00ff00;
            border-radius: 5px;
        }
        
        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .card {
                padding: 15px;
            }
            
            .card h2 {
                font-size: 1.2em;
            }
            
            .cpu-cores {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .task-item {
                grid-template-columns: 50px 1fr 60px 60px;
                font-size: 0.8em;
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 1.5em;
            }
            
            .controls {
                font-size: 0.9em;
            }
            
            .controls select {
                font-size: 0.9em;
            }
            
            .cpu-cores {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üñ•Ô∏è PiNAS System Monitor</h1>
            <div class="controls">
                <label for="refresh-rate">Refresh Rate:</label>
                <select id="refresh-rate">
                    <option value="1000">1 second</option>
                    <option value="2000" selected>2 seconds</option>
                    <option value="5000">5 seconds</option>
                    <option value="10000">10 seconds</option>
                    <option value="30000">30 seconds</option>
                </select>
            </div>
        </header>
        
        <div class="grid">
            <!-- CPU Temperature & Fan Speed Card -->
            <div class="card">
                <h2>üå°Ô∏è CPU Temp & Fan</h2>
                <div class="metric">
                    <span class="metric-label">CPU Temp:</span>
                    <span class="metric-value" id="cpu-temp">--¬∞C</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="temp-bar" style="width: 0%"></div>
                </div>
                <div class="metric" style="margin-top: 15px;">
                    <span class="metric-label">Fan Speed:</span>
                    <span class="metric-value" id="fan-duty">-- %</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="fan-bar" style="width: 0%"></div>
                </div>
                <div class="metric" style="margin-top: 10px;">
                    <span class="metric-label">PWM Value:</span>
                    <span class="metric-value" id="fan-pwm">--</span>
                </div>
            </div>
            
            <!-- CPU Frequency Card -->
            <div class="card">
                <h2>‚ö° CPU Frequency</h2>
                <div class="metric">
                    <span class="metric-label">Average:</span>
                    <span class="metric-value" id="cpu-freq-avg">-- MHz</span>
                </div>
                <div class="cpu-cores" id="cpu-cores">
                    <!-- Cores will be populated dynamically -->
                </div>
            </div>
            
            <!-- RAM Card -->
            <div class="card">
                <h2>üíæ Memory (RAM)</h2>
                <div class="metric">
                    <span class="metric-label">Used:</span>
                    <span class="metric-value" id="ram-used">-- MB</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Free:</span>
                    <span class="metric-value" id="ram-free">-- MB</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Total:</span>
                    <span class="metric-value" id="ram-total">-- MB</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Usage:</span>
                    <span class="metric-value" id="ram-percent">--%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="ram-bar" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Network Card -->
            <div class="card">
                <h2>üåê Network</h2>
                <div class="network-stats">
                    <div>
                        <div class="metric">
                            <span class="metric-label">RX:</span>
                            <span class="metric-value" id="net-rx">-- MB</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">RX Rate:</span>
                            <span class="metric-value" id="net-rx-rate">-- KB/s</span>
                        </div>
                    </div>
                    <div>
                        <div class="metric">
                            <span class="metric-label">TX:</span>
                            <span class="metric-value" id="net-tx">-- MB</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">TX Rate:</span>
                            <span class="metric-value" id="net-tx-rate">-- KB/s</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Task List Card (Full Width) -->
            <div class="card full-width">
                <h2>üìã Top Processes (by CPU)</h2>
                <div class="task-list">
                    <div class="task-item task-header">
                        <div>PID</div>
                        <div>Command</div>
                        <div>CPU %</div>
                        <div>MEM %</div>
                    </div>
                    <div id="task-list-content">
                        <!-- Tasks will be populated dynamically -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="last-update">
            Last updated: <span id="last-update">Never</span>
        </div>
    </div>
    
        <script>
        // Network rate tracking
        let lastNetworkData = null;
        let lastNetworkTime = null;
        
        let refreshInterval;
        let refreshRate = 2000;
        
        // Update refresh rate
        document.getElementById('refresh-rate').addEventListener('change', function() {
            refreshRate = parseInt(this.value);
            if (refreshInterval) {
                clearInterval(refreshInterval);
                startAutoRefresh();
            }
        });
        
        async function updateData() {
            try {
                // Fetch all data from API
                const response = await fetch('/api/all');
                const data = await response.json();
                
                // Update CPU Temperature & Fan
                if (data.cpu_temp) {
                    document.getElementById('cpu-temp').textContent = `${data.cpu_temp.temperature}¬∞${data.cpu_temp.unit}`;
                    const tempPercent = Math.min((data.cpu_temp.temperature / 80) * 100, 100);
                    document.getElementById('temp-bar').style.width = `${tempPercent}%`;
                }
                
                if (data.fan) {
                    document.getElementById('fan-duty').textContent = `${data.fan.duty_cycle} ${data.fan.unit}`;
                    document.getElementById('fan-bar').style.width = `${data.fan.duty_cycle}%`;
                    document.getElementById('fan-pwm').textContent = data.fan.pwm_value;
                }
                
                // Update CPU Frequency
                if (data.cpu_freq) {
                    document.getElementById('cpu-freq-avg').textContent = `${data.cpu_freq.average} ${data.cpu_freq.unit}`;
                    
                    const coresContainer = document.getElementById('cpu-cores');
                    coresContainer.innerHTML = '';
                    
                    data.cpu_freq.cores.forEach(core => {
                        const coreDiv = document.createElement('div');
                        coreDiv.className = 'core';
                        coreDiv.innerHTML = `
                            <div>Core ${core.core}</div>
                            <div style="font-size: 1.2em; margin-top: 5px;">${core.frequency} MHz</div>
                        `;
                        coresContainer.appendChild(coreDiv);
                    });
                }
                
                // Update RAM
                if (data.ram) {
                    document.getElementById('ram-used').textContent = `${data.ram.used} ${data.ram.unit}`;
                    document.getElementById('ram-free').textContent = `${data.ram.free} ${data.ram.unit}`;
                    document.getElementById('ram-total').textContent = `${data.ram.total} ${data.ram.unit}`;
                    document.getElementById('ram-percent').textContent = `${data.ram.percent}%`;
                    document.getElementById('ram-bar').style.width = `${data.ram.percent}%`;
                }
                
                // Update Network with rate calculation
                if (data.network) {
                    const currentTime = Date.now();
                    
                    document.getElementById('net-rx').textContent = `${data.network.rx_mb} MB`;
                    document.getElementById('net-tx').textContent = `${data.network.tx_mb} MB`;
                    
                    // Calculate rates if we have previous data
                    if (lastNetworkData && lastNetworkTime) {
                        const timeDiff = (currentTime - lastNetworkTime) / 1000; // seconds
                        const rxDiff = data.network.rx_bytes - lastNetworkData.rx_bytes;
                        const txDiff = data.network.tx_bytes - lastNetworkData.tx_bytes;
                        
                        const rxRate = (rxDiff / timeDiff / 1024).toFixed(1); // KB/s
                        const txRate = (txDiff / timeDiff / 1024).toFixed(1); // KB/s
                        
                        document.getElementById('net-rx-rate').textContent = `${rxRate} KB/s`;
                        document.getElementById('net-tx-rate').textContent = `${txRate} KB/s`;
                    } else {
                        document.getElementById('net-rx-rate').textContent = '-- KB/s';
                        document.getElementById('net-tx-rate').textContent = '-- KB/s';
                    }
                    
                    lastNetworkData = data.network;
                    lastNetworkTime = currentTime;
                }
                
                // Update Tasks
                if (data.tasks && data.tasks.tasks) {
                    const taskListContent = document.getElementById('task-list-content');
                    taskListContent.innerHTML = '';
                    
                    data.tasks.tasks.forEach(task => {
                        const taskDiv = document.createElement('div');
                        taskDiv.className = 'task-item';
                        taskDiv.innerHTML = `
                            <div>${task.pid}</div>
                            <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${task.command}</div>
                            <div>${task.cpu}%</div>
                            <div>${task.mem}%</div>
                        `;
                        taskListContent.appendChild(taskDiv);
                    });
                }
                
                // Update last update time
                document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
                
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }
        
        function startAutoRefresh() {
            updateData();
            refreshInterval = setInterval(updateData, refreshRate);
        }
        
        // Start auto-refresh on page load
        startAutoRefresh();
    </script>
</body>
</html>
